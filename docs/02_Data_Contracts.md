# Data Contracts

**Purpose:** Define all input/output schemas, raw file formats, parsed output formats, and field-level assumptions for the Performance Meal Planner pipeline.

**Owner/Process:** Engineering — update when schemas or parsers change.

---

## 1. Schema Overview

All schemas live in `schemas/` and use JSON Schema draft-07 with `additionalProperties: false`.

| Schema File | Title | Direction | Validated In |
|---|---|---|---|
| `user_profile.schema.json` | UserProfile | Input | `run_weekly.py` |
| `weekly_context.schema.json` | WeeklyContext | Input | `run_weekly.py` |
| `outcome_signals.schema.json` | OutcomeSignals | Input | `run_weekly.py` |
| `meal_plan.schema.json` | MealPlan | Output | `run_weekly.py` |
| `grocery_list.schema.json` | GroceryList | Output | `run_weekly.py` |
| `weekly_outputs.schema.json` | WeeklyOutputs | Output | `run_weekly.py` |

---

## 2. Input Schemas

### 2.1 UserProfile

Source: `demo_inputs/user_profile.json` (demo) or `demo_inputs/parsed/user_profile.json` (from --ingest).

| Field | Type | Required | Notes |
|---|---|---|---|
| `user_id` | string | Yes | Arbitrary identifier |
| `name` | string | Yes | Display name |
| `age` | integer | Yes | Years |
| `sex` | enum | Yes | female/male/nonbinary/unspecified |
| `height_cm` | number | Yes | Centimeters |
| `weight_kg` | number | Yes | Kilograms; protein target = max(140, weight * 2.0) g/day |
| `goal` | enum | Yes | maintain/gain/cut |
| `dietary_preferences` | array | Yes | e.g. ["high-protein", "mediterranean"] |
| `allergies` | array | No | QA checks meal names against these |
| `avoid_list` | array | No | Same QA check as allergies |
| `cooking_time_max_min` | integer | No | Not used in V1 meal selection |
| `budget_level` | enum | No | low/medium/high; not used in V1 |

### 2.2 WeeklyContext

Source: `demo_inputs/weekly_context.json` (demo) or `demo_inputs/parsed/weekly_context.json` (from --ingest).

| Field | Type | Required | Notes |
|---|---|---|---|
| `week_start` | ISO date | Yes | Monday of target week |
| `timezone` | string | Yes | IANA timezone e.g. "America/Los_Angeles" |
| `training_focus` | string | Yes | Human-readable label; auto-generated by Garmin parser (flagged) |
| `schedule` | array[7] | Yes | One entry per day Mon-Sun |
| `schedule[].date` | ISO date | Yes | |
| `schedule[].day_type` | enum | Yes | rest/training/high — drives macro targets and meal selection |
| `schedule[].notes` | string | Yes | Activity description or "No activity recorded" |

### 2.3 OutcomeSignals

Source: `demo_inputs/outcome_signals.json` — edit manually each week.

| Field | Type | Required | Notes |
|---|---|---|---|
| `week_start` | ISO date | Yes | |
| `garmin_summary.avg_sleep_hr` | number | Yes | Use 0.0 if unknown |
| `garmin_summary.avg_steps` | integer | Yes | Use 0 if unknown |
| `garmin_summary.training_load` | string | Yes | low / moderate / high |
| `mfp_summary.avg_kcal` | number | Yes | Prior-week avg daily calories |
| `mfp_summary.protein_g` | number | Yes | Prior-week avg daily protein (g) |
| `mfp_summary.carbs_g` | number | Yes | Prior-week avg daily carbs (g) |
| `mfp_summary.fat_g` | number | Yes | Prior-week avg daily fat (g) |

Note: `mfp_summary` is named for historical reasons. Enter values from any tracking source.

---

## 3. Output Schemas

### 3.1 MealPlan

| Field | Notes |
|---|---|
| `week_start` | ISO date |
| `days[].date` | ISO date |
| `days[].day_type` | rest/training/high |
| `days[].meals[].name` | Display name with meal type prefix |
| `days[].meals[].time` | HH:MM 24h |
| `days[].meals[].recipe_link` | URL; empty string allowed for simple builds |
| `days[].meals[].macros` | {kcal, protein_g, carbs_g, fat_g} |
| `days[].meals[].ingredients[]` | {name, quantity, unit, category} |

### 3.2 GroceryList

Items normalized and rolled up by `normalize_grocery.py`.

| Field | Required | Notes |
|---|---|---|
| `name_display` | Yes | Original name |
| `name_normalized` | Yes | Lowercased, aliased, singularized via PLURAL_MAP |
| `total_quantity` | Yes | Rolled up across all days |
| `unit` | Yes | Normalized (g, ml, count, etc.) |
| `category` | Yes | produce/protein/dairy/pantry/etc. |
| `source_days` | Yes | ISO dates where ingredient appears |
| `notes` | No | e.g. "Unit conversion applied" |
| `store_item_name` | No | Kroger product description + size |
| `store_product_id` | No | Kroger internal product ID |
| `store_sku` | No | Kroger UPC for cart push |
| `price_usd` | No | Current price at configured location |
| `match_confidence` | No | 0.0-1.0 fuzzy match score |
| `match_type` | No | exact (>=0.85) / approximate (>=0.45) / no_match |

Store fields populated only when `--kroger-search` is run.

### 3.3 WeeklyOutputs

| Field | Notes |
|---|---|
| `week_start` | ISO date |
| `per_day_targets[7]` | {date, day_type, calories_target, protein_g, carbs_g, fat_g, notes} |
| `meal_plan` | Full MealPlan object |
| `grocery_list` | Full GroceryList object |
| `nutrition_brief` | {summary, targets: {kcal, protein_g, carbs_g, fat_g}} — weekly averages |
| `email_digest` | Full text of Weekly_Email_Digest.md |

---

## 4. Raw Input Formats

### 4.1 Garmin Connect Activities CSV

**How to export:**
1. Go to https://connect.garmin.com/modern/activities
2. Click the download icon (top-right of activity list)
3. Select Export to CSV
4. Save as `demo_inputs/raw/garmin_activities.csv`

**Columns used by parser:**

| Column | Purpose | Notes |
|---|---|---|
| `Activity Type` | Day-type classification | See ACTIVITY_TYPE_MAP in garmin_import.py |
| `Date` | Week filtering | Formats: YYYY-MM-DD HH:MM:SS or MM/DD/YYYY |
| `Distance` | High-day threshold (>=12 km) | ASSUMED METRIC. Set Garmin Connect to metric before export. |
| `Aerobic TE` | High-day threshold (>=3.5) | Aerobic Training Effect, 0-5 scale |
| `Title` | notes field in schedule | Activity name |

**Parser assumptions:**
- Week starts Monday (ISO week convention)
- Multiple activities same day: highest-intensity day_type wins
- Days with no activity: "rest"
- training_focus is auto-generated, flagged "(auto-generated)" — review before use
- avg_sleep_hr and avg_steps in outcome_signals.json are NOT populated from this CSV (edit manually)

### 4.2 User Intake CSV

**File:** `demo_inputs/raw/user_intake.csv`

Single-row CSV. Edit with any text editor or spreadsheet.

| Column | Type | Example | Notes |
|---|---|---|---|
| `user_id` | string | u_001 | Keep stable across weeks |
| `name` | string | Alex Runner | |
| `age` | integer | 32 | |
| `sex` | string | male | female/male/nonbinary/unspecified |
| `height_cm` | number | 178 | Centimeters |
| `weight_kg` | number | 74 | Kilograms |
| `goal` | string | maintain | maintain/gain/cut |
| `dietary_preferences` | comma-separated | "high-protein,mediterranean" | Quote cell if using commas |
| `allergies` | comma-separated | peanuts | |
| `avoid_list` | comma-separated | "peanuts,lamb" | |
| `cooking_time_max_min` | integer | 30 | Optional |
| `budget_level` | string | medium | low/medium/high; optional |

---

## 5. Kroger Product Resolution

When `--kroger-search` is run:

1. Search: `GET /v1/products?filter.term={name_normalized}&filter.locationId={location_id}&filter.limit=5`
2. Score: difflib.SequenceMatcher ratio between name_normalized and each result's description
3. Classify: exact (>=0.85), approximate (>=0.45), no_match (<0.45)
4. Annotate: best match fields written to grocery item

Config: `demo_inputs/kroger_config.json` (gitignored — never commit credentials).
Output: `outputs/demo/kroger_cart_request.json`

---

## 6. Missing Data Defaults

| Missing Input | Default | Label |
|---|---|---|
| Garmin CSV absent | --ingest skips Garmin; existing weekly_context.json used | None |
| outcome_signals values unknown | Use 0 for sleep/steps; "moderate" for training_load | None (manual file) |
| Kroger credentials missing | --kroger-search prints error and skips | "price unavailable" in Grocery_List.md |
| No Kroger match found | match_type: no_match; excluded from cart payload | listed in cart_request.skipped[] |
| training_focus auto-generated | Value appended with "(auto-generated)" | Yes |
